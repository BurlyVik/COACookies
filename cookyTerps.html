<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Terpene Viewer ‚Äî COACookies</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; background: #f5f5f5; margin: 0; }
    h1 { text-align: center; font-size: 1.5rem; }
    #status { text-align: center; margin-top: 10px; color: #666; font-size: 0.9rem; }
    #progressBarContainer { width: 100%; background: #ddd; border-radius: 5px; height: 10px; margin: 10px auto; max-width: 400px; overflow: hidden; }
    #progressBar { width: 0%; height: 100%; background: #007bff; transition: width 0.3s ease; }


    #filterContainer { text-align: center; margin-top: 10px; }
    #subcategoryFilter { font-size: 0.9rem; padding: 3px 5px; }

    table { width: 100%; margin-top: 20px; border-collapse: collapse; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); font-size: 0.8rem; table-layout: fixed; word-wrap: break-word; }
    th, td { padding: 6px; border: 1px solid #ccc; text-align: center; }
    th { background: #007bff; color: white; cursor: pointer; position: relative; }
    tr:nth-child(even) { background: #f9f9f9; }
    a.product-link { color: #007bff; text-decoration: none; }
    a.product-link:hover { text-decoration: underline; }
    img.product-img { max-width: 60px; max-height: 60px; object-fit: contain; }
    td.highlight-row { background-color: #b8ffc9 !important; }
    td.highlight-col { background-color: #d7b6e0 !important; }
    td.highlight-cell { background-color: #ffffff !important; }

    .info-icon {
      font-size: 1.1em;
      cursor: pointer;
      line-height: 1;
    }


    .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 999; padding: 10px; }
    .overlay-content { background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto; box-shadow: 0 0 20px rgba(0,0,0,0.3); font-size: 0.9rem; text-align: left; }
    .error { color: red; text-align: center; }


    @media (max-width: 768px) {
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        font-size: 0.75rem;
      }

      th, td {
        padding: 4px;
      }

      h1 {
        font-size: 1.2rem;
      }

      #subcategoryFilter {
        font-size: 0.85rem;
        padding: 4px;
      }

      img.product-img {
        max-width: 40px;
        max-height: 40px;
      }
    }

    /* Very small devices */
    @media (max-width: 480px) {
      h1 {
        font-size: 1rem;
      }

      #filterContainer {
        font-size: 0.8rem;
      }

      .info-icon {
        font-size: 1rem;
      }
    }
</style>

</head>

<body>
  <h1 id="pageTitle">Terpene Data</h1>
  <div id="status">Loading...</div>

  <div id="progressBarContainer"><div id="progressBar"></div></div>


  <div id="filterContainer">
    <label for="subcategoryFilter" style="margin-right: 6px; font-weight: bold;">Filter:</label>
    <select id="subcategoryFilter">
      <option value="all">All Products</option>
      <option value="vapes">Vapes</option>
      <option value="concentrates">Concentrates</option>
      <option value="pre-rolls">Pre-rolls</option>
      <option value="premium-flower">Premium Flower</option>
    </select>
  </div>

  <div id="tableContainer"></div>

  <div id="overlay" class="overlay" onclick="if(event.target.id==='overlay'){ this.style.display='none'; }">
    <div id="overlayContent" class="overlay-content"></div>
  </div>

<script>
const progressBar = document.getElementById("progressBar");
function updateProgress(percent) { progressBar.style.width = percent + "%"; }
updateProgress(5);

const params = new URLSearchParams(window.location.search);
const retailer = params.get("retailer") || "tampa";
const displayName = retailer.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
document.getElementById("pageTitle").textContent = `Terpenes ‚Äî ${displayName}`;

let allFetchedProducts = [];


Promise.all([
  fetch(`https://cookiesflorida.co/wp-json/dovetail-api/v1/products?page=1&perpage=100&orderby=popular&order=desc&retailer=${retailer}&menutype=medical&categories[]=vapes`).then(r => r.text()),
  fetch(`https://cookiesflorida.co/wp-json/dovetail-api/v1/products?page=1&perpage=100&orderby=popular&order=desc&retailer=${retailer}&menutype=medical&categories[]=concentrates`).then(r => r.text()),
  fetch(`https://cookiesflorida.co/wp-json/dovetail-api/v1/products?page=1&perpage=100&orderby=popular&order=desc&retailer=${retailer}&menutype=medical&categories[]=pre-rolls`).then(r => r.text()),
  fetch(`https://cookiesflorida.co/wp-json/dovetail-api/v1/products?page=1&perpage=100&orderby=popular&order=desc&retailer=${retailer}&menutype=medical&categories[]=premium-flower`).then(r => r.text())
]).then(([vapeData, concData, prerollData, flowerData]) => {
  updateProgress(40);

  const vapeProducts = fixMalformedJson(vapeData).flatMap(p => p.results ?? []);
  vapeProducts.forEach(p => p._sourceCategory = "vapes");

  const concProducts = fixMalformedJson(concData).flatMap(p => p.results ?? []);
  concProducts.forEach(p => p._sourceCategory = "concentrates");

  const prerollProducts = fixMalformedJson(prerollData).flatMap(p => p.results ?? []);
  prerollProducts.forEach(p => p._sourceCategory = "pre-rolls");

  const flowerProducts = fixMalformedJson(flowerData).flatMap(p => p.results ?? []);
  flowerProducts.forEach(p => p._sourceCategory = "premium-flower");

  allFetchedProducts = [...vapeProducts, ...concProducts, ...prerollProducts, ...flowerProducts];

  updateProgress(80);
  renderTerpeneTable(allFetchedProducts);
  updateProgress(100);
}).catch(err => {
  document.getElementById("status").innerHTML = `<p class="error">Failed to load data for <strong>${displayName}</strong>.</p>`;
  console.error(err);
});

function fixMalformedJson(raw) {
  const trimmed = raw.trim();
  const needsStart = !trimmed.startsWith("[");
  const needsEnd = !trimmed.endsWith("]");
  return JSON.parse(`${needsStart ? "[" : ""}${trimmed}${needsEnd ? "]" : ""}`);
}


document.getElementById("subcategoryFilter").addEventListener("change", function () {
  const selected = this.value;
  if (selected === "all") {
    renderTerpeneTable(allFetchedProducts);
  } else {
    const filtered = allFetchedProducts.filter(p => p._sourceCategory === selected);
    renderTerpeneTable(filtered);
  }
});

function renderTerpeneTable(products) {
  const excludedTerpenes = ["Guaiol", "Eucalyptol", "Isopulegol", "Nerolidol", "Terpinene"];
const allTerpenes = [...new Set(
  products.flatMap(p => (p.terpenes ?? [])
    .map(t => t.name)
    .filter(name => name && !excludedTerpenes.includes(name))
  )
)].sort();
  const columns = ["Image", "Price", "ProductName", "Delivery", ...allTerpenes];

  const rows = products.map(p => {
    const terpMap = Object.fromEntries((p.terpenes ?? []).map(t => [t.name, typeof t.value === "number" ? t.value.toFixed(2) : ""]));
    
let priceValue = "";
if (Array.isArray(p.variants) && p.variants.length > 0) {
  const variantPrice = p.variants[0].price ?? p.variants[0].regular_price;
  if (variantPrice !== undefined && variantPrice !== null) {
    priceValue = `$${parseFloat(variantPrice).toFixed(2)}`;
  }
}

return {
  Image: p.images?.[0]?.url || "",
  Price: priceValue || "‚Äî",
  ProductName: `<a class="product-link" href="${p.permalink || p.link || "#"}" target="_blank">${p.name}</a>`,
  Delivery: p.subcategory || "",
  ...Object.fromEntries(allTerpenes.map(t => [t, terpMap[t] ?? ""]))
};

  });
  createSortableTable(columns, rows);
  document.getElementById("status").textContent = `Loaded ${rows.length} products.`;
}

function createSortableTable(columns, data) {
  const table = document.createElement("table");
  const thead = table.createTHead();
  const headRow = thead.insertRow();

  columns.forEach(col => {
    const th = document.createElement("th");
    th.style.position = "relative";
    th.style.textAlign = "center";
    th.style.whiteSpace = "normal";

    if (terpeneDescriptions[col]) {

  const headerFlex = document.createElement("div");
  headerFlex.style.display = "flex";
  headerFlex.style.justifyContent = "space-between";
  headerFlex.style.alignItems = "center";
  headerFlex.style.width = "100%";


  const colLabel = document.createElement("span");
  colLabel.textContent = col;

  const infoIcon = document.createElement("span");
  infoIcon.className = "info-icon";
  infoIcon.textContent = "‚ÑπÔ∏è";
  infoIcon.onclick = (e) => showDescription(e, col);

  headerFlex.appendChild(colLabel);
  headerFlex.appendChild(infoIcon);
  th.appendChild(headerFlex);
} else {
  th.textContent = col;
}


    th.addEventListener("click", () => sortBy(col, data));
    headRow.appendChild(th);
  });

  const tbody = table.createTBody();
  data.forEach((row, rowIndex) => {
    const tr = tbody.insertRow();
    columns.forEach((col, colIndex) => {
      const td = tr.insertCell();
      if (col === "Image" && row[col]) {
        td.innerHTML = `<img class="product-img" src="${row[col]}" alt="Image" />`;
      } else {
        td.innerHTML = row[col] || "";
      }
      td.addEventListener("mouseenter", () => highlight(table, rowIndex + 1, colIndex));
      td.addEventListener("mouseleave", () => clearHighlights(table));
    });
  });

  const container = document.getElementById("tableContainer");
  container.innerHTML = "";
  container.appendChild(table);
}



function highlight(table, rowIndex, colIndex) {
  clearHighlights(table);
  const rows = table.rows;
  if (colIndex !== 0) {
    for (let i = 1; i < rows.length; i++) {
      if (rows[i].cells[colIndex]) rows[i].cells[colIndex].classList.add("highlight-col");
    }
  }
  if (rows[rowIndex]) {
    [...rows[rowIndex].cells].forEach((cell, i) => {
      cell.classList.add("highlight-row");
      if (i === colIndex) cell.classList.add("highlight-cell");
    });
  }
}

function clearHighlights(table) {
  const cells = table.querySelectorAll(".highlight-col, .highlight-row, .highlight-cell");
  cells.forEach(cell => cell.classList.remove("highlight-col", "highlight-row", "highlight-cell"));
}

function sortBy(col, data) {
  const isNumeric = data.every(row => !isNaN(parseFloat(row[col])) || row[col] === "");
  const sorted = [...data].sort((a, b) => {
    const av = isNumeric ? parseFloat(a[col]) || 0 : (a[col] || "").toLowerCase();
    const bv = isNumeric ? parseFloat(b[col]) || 0 : (b[col] || "").toLowerCase();
    return isNumeric ? bv - av : av.localeCompare(bv);
  });
  createSortableTable(Object.keys(sorted[0]), sorted);
}

function showDescription(event, col) {
  event.stopPropagation();
  const content = document.getElementById("overlayContent");
  content.innerHTML = terpeneDescriptions[col] || "No description.";
  document.getElementById("overlay").style.display = "flex";
}

  // emojis retreived from emojiDB
const terpeneDescriptions = {
      "Alpha Pinene": `üå≤ <strong>Alpha Pinene</strong><br><br>‚Ä¢ Smells like: Pine trees<br>‚Ä¢ Feels like: Focused, alert, awake<br>‚Ä¢ Helps with: Memory, asthma (opens airways)<br>‚Ä¢ Real life: Found in pine needles, rosemary`,
      "Beta Caryophyllene": `üßÅ <strong>Beta Caryophyllene</strong><br><br>‚Ä¢ Smells like: Peppery, spicy<br>‚Ä¢ Feels like: Calm, pain relief<br>‚Ä¢ Helps with: Anxiety, inflammation<br>‚Ä¢ Cool fact: Binds to cannabinoid receptors`,
      "Beta Myrcene": `üõã <strong>Beta Myrcene</strong><br><br>‚Ä¢ Smells like: Earthy, musky, mango<br>‚Ä¢ Feels like: Super relaxed, sleepy<br>‚Ä¢ Helps with: Pain, insomnia<br>‚Ä¢ High dose = couch-lock`,
      "Beta Pinene": `üåø <strong>Beta Pinene</strong><br><br>‚Ä¢ Smells like: Pine, herbs<br>‚Ä¢ Feels like: Energized, clear-headed<br>‚Ä¢ Helps with: Memory, mood, allergies`,
      "Camphene": `üî• <strong>Camphene</strong><br><br>‚Ä¢ Smells like: Camphor (like Vicks VapoRub)<br>‚Ä¢ Feels like: Clean, breathing easier<br>‚Ä¢ Helps with: Inflammation, heart health (early studies)`,
      "Caryophyllene Oxide": `üå∂ <strong>Caryophyllene Oxide</strong><br><br>‚Ä¢ Smells like: Spicy, woody<br>‚Ä¢ Feels like: Calm, anti-inflammatory<br>‚Ä¢ Helps with: Stress, fungi<br>‚Ä¢ Bonus: What drug-sniffing dogs smell in weed`,
      "Geraniol": `üå∏ <strong>Geraniol</strong><br><br>‚Ä¢ Smells like: Roses, sweet flowers<br>‚Ä¢ Feels like: Uplifted, calm<br>‚Ä¢ Helps with: Antioxidant support, possible anti-cancer benefits`,
      "Humulene": `üç∫ <strong>Humulene</strong><br><br>‚Ä¢ Smells like: Hops, beer, wood<br>‚Ä¢ Feels like: Not hungry, relaxed<br>‚Ä¢ Helps with: Appetite control, pain relief`,
      "Limonene": `üçã <strong>Limonene</strong><br><br>‚Ä¢ Smells like: Lemon, citrus<br>‚Ä¢ Feels like: Happy, energized<br>‚Ä¢ Helps with: Mood, anxiety, digestion`,
      "Linalool": `üõÄ <strong>Linalool</strong><br><br>‚Ä¢ Smells like: Lavender<br>‚Ä¢ Feels like: Sleepy, calm<br>‚Ä¢ Helps with: Anxiety, pain, sleep`,
      "Ocimene": `üå¨ <strong>Ocimene</strong><br><br>‚Ä¢ Smells like: Sweet, herbal, minty<br>‚Ä¢ Feels like: Uplifted, alert<br>‚Ä¢ Helps with: Antiviral, antifungal`,
      "Para Cymene": `üßÇ <strong>Para Cymene</strong><br><br>‚Ä¢ Smells like: Mild spice, citrus<br>‚Ä¢ Feels like: Subtle relaxation<br>‚Ä¢ Helps with: Inflammation, infection-fighting`,
      "Terpinolene": `ü™µ <strong>Terpinolene</strong><br><br>‚Ä¢ Smells like: Mixed ‚Äî pine, floral, citrus<br>‚Ä¢ Feels like: Uplifted, creative<br>‚Ä¢ Helps with: Antioxidant, calm but not sleepy`,
      "Trans-Nerolidol": `üß¥ <strong>Trans-Nerolidol</strong><br><br>‚Ä¢ Smells like: Floral, apple, tea-tree oil<br>‚Ä¢ Feels like: Sedating, chill<br>‚Ä¢ Helps with: Skin healing, antibacterial`,
      "Bisabolol": `üåº <strong>Bisabolol</strong><br><br>‚Ä¢ Smells like: Sweet, floral (like chamomile)<br>‚Ä¢ Feels like: Calm, soothing<br>‚Ä¢ Helps with: Inflammation, skin repair, anxiety<br>‚Ä¢ Fun fact: Main ingredient in chamomile‚Äôs relaxing effect`
    };
</script>
</body>
</html>
